version: 0.2

env:
  variables:
    TERRAFORM_ACTION: "plan"              # Cambia a "destroy" para ejecutar terraform destroy
    ENVIRONMENT: "dev"

cache:
  paths:
    - /usr/bin/terraform
    - /root/.terraform.d/plugin-cache

phases:
  pre_build:
    commands:
      - echo "Pre-build phase"
      - echo "Installing Terraform version ${TERRAFORM_VERSION}..."
      - dnf install -y dnf-utils
      - dnf config-manager --add-repo https://rpm.releases.hashicorp.com/AmazonLinux/hashicorp.repo
      - dnf list available | grep hashicorp
      - dnf -y install terraform-${TERRAFORM_VERSION}-1.x86_64

  build:
    commands:
      - echo "Changing the directory to the deployment path..."
      - echo "Initializing Terraform..."
      - terraform init
      - terraform plan --var-file="dev.tfvars" -out=tfplan
      # - terraform terraform apply -auto-approve tfplan

      - |
        echo "========================================"
        echo "üéâ TERRAFORM DEPLOYMENT COMPLETED! üéâ"
        echo "========================================"
        echo "‚úÖ Service: Splunk Lambda"
        echo "‚úÖ Environment: $ENVIRONMENT"
        echo "‚úÖ Timestamp: $(date)"
        echo "========================================"
  # post_build:
  #   commands:
  #     - echo "üì§ Starting notification process..."
  #     - echo "SNS Topic ARN= $SNS_TOPIC_NOTIFY"
  #     - |
  #       # Extraer outputs de Terraform con manejo de errores
  #       echo "üìä Extracting Terraform outputs..."
  #       if terraform output -json > tfoutputs.json 2>/dev/null; then
  #         echo "‚úÖ Terraform outputs extracted successfully"
  #       else
  #         echo "‚ö†Ô∏è  No Terraform outputs available or error occurred"
  #         echo '{}' > tfoutputs.json
  #       fi
  #     - |
  #       # Crear mensaje de notificaci√≥n detallado
  #       TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
  #       cat > notification.json << EOF
  #       {
  #         "deployment": {
  #           "service": "$API_NAME",
  #           "environment": "$ENVIRONMENT",
  #           "subdomain": "$subdomain",
  #           "action": "$TERRAFORM_ACTION",
  #           "timestamp": "$TIMESTAMP",
  #           "commit_id": "$COMMIT_ID",
  #           "branch": "$BRANCH_NAME",
  #           "status": "SUCCESS"
  #         },
  #         "terraform_outputs": $(cat tfoutputs.json)
  #       }
  #       EOF
  #     - |
  #       # Enviar notificaci√≥n con manejo de errores
  #       echo "üì® Sending deployment notification..."
  #       if aws sns publish \
  #         --topic-arn "$SNS_TOPIC_NOTIFY" \
  #         --subject "‚úÖ DEPLOY SUCCESS: $API_NAME ($ENVIRONMENT)" \
  #         --message file://notification.json > /dev/null 2>&1; then
  #         echo "========================================"
  #         echo "‚úÖ NOTIFICATION SENT SUCCESSFULLY! ‚úÖ"
  #         echo "========================================"
  #       else
  #         echo "========================================"
  #         echo "‚ö†Ô∏è  NOTIFICATION FAILED (BUT DEPLOY OK) ‚ö†Ô∏è"
  #         echo "========================================"
  #       fi
  #     - |
  #       echo "========================================"
  #       echo "üèÅ PIPELINE EXECUTION COMPLETED! üèÅ"
  #       echo "========================================"
  #       echo "Service: $API_NAME"
  #       echo "Status: SUCCESS ‚úÖ"
  #       echo "Time: $(date)"
  #       echo "========================================"